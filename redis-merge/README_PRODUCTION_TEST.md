# Redis数据库合并生产环境测试指南

## 概述

本文档介绍如何使用Redis比较与合并工具进行生产环境测试，特别关注集合元素的合并。该工具提供了完整的测试流程，包括数据准备、合并执行、结果验证和报告生成。

## 功能特性

- ✅ **模拟生产环境数据**：创建真实的生产环境模拟数据，包括String、Hash、List、Set等多种数据类型
- ✅ **完整测试流程**：数据准备 → 合并执行 → 结果验证 → 报告生成
- ✅ **集合元素合并验证**：特别关注Set类型数据的合并，确保所有唯一元素都被正确保留
- ✅ **列表元素合并验证**：验证List类型数据的合并，确保所有元素都被正确合并
- ✅ **命令行参数支持**：灵活配置Redis服务器地址、端口、数据库编号等
- ✅ **详细日志记录**：生成完整的执行日志，便于问题排查
- ✅ **合并报告生成**：输出详细的合并报告，包括合并统计和验证结果
- ✅ **自动清理测试数据**：测试完成后自动清理，保持环境干净

## 使用方法

### 基本用法

使用现有的测试脚本：

```bash
python test_merge.py
```

### 配置参数

当前测试脚本使用硬编码配置，但您可以直接修改脚本中的配置：

```python
# 在test_merge.py中修改配置
config1 = {'host': 'localhost', 'port': 6379, 'db': 4, 'decode_responses': True}
config2 = {'host': 'localhost', 'port': 6379, 'db': 5, 'decode_responses': True}
config3 = {'host': 'localhost', 'port': 6379, 'db': 6, 'decode_responses': True}
```

## 测试流程

1. **数据准备**：在DB1和DB2中创建模拟的生产环境数据
2. **合并执行**：调用`merge_to_new_db`函数将DB1和DB2的数据合并到DB3
3. **结果验证**：验证合并结果是否符合预期，特别是集合元素的合并
4. **报告生成**：输出详细的合并报告，包括合并统计和验证结果
5. **数据清理**：清理测试数据，保持环境干净

## 验证内容

脚本验证以下合并功能：

1. **String类型合并**：验证系统配置等String类型数据是否选择最新版本
2. **Hash类型合并**：验证用户详细信息等Hash类型数据是否正确合并
3. **List类型合并**：验证用户操作日志等List类型数据是否合并所有元素
4. **Set类型合并**：验证用户角色等Set类型数据是否合并所有唯一元素
5. **独有键合并**：验证DB1和DB2中独有的键是否都正确合并到DB3

## 输出信息

- **控制台输出**：详细的执行日志和合并结果
- **日志文件**：`production_merge_test.log`（由redis_merge.py生成）

## 测试数据说明

脚本在DB1和DB2中创建以下模拟数据：

### DB1数据

- **String**：用户基本信息、系统配置
- **Hash**：用户详细信息（id、name、email、department、join_date）
- **List**：用户操作日志（登录系统、查看订单、修改密码）
- **Set**：用户角色（user、editor、reviewer）、系统活跃模块（auth、user、order）

### DB2数据

- **String**：用户基本信息（与DB1部分重叠）、用户联系方式、系统配置（更新版本）
- **Hash**：用户详细信息（与DB1部分字段不同）
- **List**：用户操作日志（与DB1不同）
- **Set**：用户角色（与DB1有重叠但不完全相同）、系统活跃模块（比DB1多两个模块）

## 合并结果预期

- **String类型**：系统配置选择DB2的更新版本
- **Hash类型**：用户信息合并DB2的字段（因为default_preference=db2）
- **List类型**：合并DB1和DB2的所有操作日志
- **Set类型**：合并两个数据库的所有唯一角色和模块
- **独有键**：合并DB1和DB2中所有独有的键

## 依赖项

- Redis数据库服务器
- Python 3.6+
- redis-py库

## 安装依赖

```bash
pip install redis
```

## 注意事项

1. 测试过程中会清空DB1、DB2和DB3的所有数据，请确保这些数据库可以用于测试
2. 建议在非生产环境中进行测试，避免影响实际业务数据
3. 测试完成后会自动清理测试数据，保持环境干净
4. 生成的日志和报告文件可以用于后续分析和问题排查

## 故障排除

如果测试失败，请检查以下几点：

1. Redis服务器是否正常运行
2. Redis连接配置是否正确
3. 数据库编号是否正确（避免使用生产环境数据库）
4. 查看控制台输出获取详细错误信息
5. 检查`production_merge_test.log`日志文件了解执行过程

## 扩展建议

1. 根据实际业务需求调整测试数据结构和内容
2. 增加更多数据类型的测试，如ZSet、Stream、Geo等
3. 扩展验证逻辑，增加更复杂的业务场景验证
4. 集成到CI/CD流程中，定期执行测试确保合并功能正常
5. 增加性能测试，评估大数据量下的合并效率